# $Id$

###############################
# ezmlm-sub/unsub/list/issubn #
###############################

  prompt "ezmlm-[un|is]sub[n]:  "

  SENDER="XYZZY@HOst"

# With mysql testing, there may be junk left from earlier testing that
# gives false positives in testing. Make sure it's detected
  file_run ezmlm-list "$DIR" || \
	fatal "ezmlm-list: failed"

  run ezmlm-list "$DIR" | ${GREP} '@' >/dev/null 2>&1 && \
	fatal "already addresses in table - please remove and start again"

  run ezmlm-list "${DIR}/digest" | ${GREP} '@' >/dev/null 2>&1 && \
	fatal "already addresses in table - please remove and start again"

  run ezmlm-list "${DIR}/allow" | ${GREP} '@' >/dev/null 2>&1 && \
	fatal "already addresses in table - please remove and start again"

# not subscriber. Test default
  file_run ezmlm-issubn "$DIR" "${DIR}/allow" && \
	fatal "ezmlm-issubn: failed: exit 0 on non-subscriber (absolute)"
  file_run ezmlm-issubn "$DIR" . allow && \
	fatal "ezmlm-issubn: failed: exit 0 on non-subscriber (relative)"

# not subscriber. Test -n
  file_run ezmlm-issubn -n "$DIR" "${DIR}/allow" || \
	fatal "ezmlm-issubn: -n failed for non-subscriber (absolute)"
  file_run ezmlm-issubn -n "$DIR" . allow || \
	fatal "ezmlm-issubn: -n failed for non-subscriber (relative)"

# add subscriber
  file_run ezmlm-sub "$DIR" "xyZZy@hoSt" || \
	fatal "ezmlm-sub: failed to add subscriber"

# is subscriber. Test default
  file_run ezmlm-issubn "$DIR" . allow || \
	fatal "ezmlm-issubn: failed: exit false for subscriber"

# is subscriber. Test -n
  file_run ezmlm-issubn -n "$DIR" . allow && \
	fatal "ezmlm-issubn: -n failed for subscriber"

# add to allow
  file_run ezmlm-sub "$DIR" allow "ZZtop@hoSt" || \
	fatal "ezmlm-sub: failed to add address to ${DIR}/allow"
  run ezmlm-list "$DIR"/allow | ${GREP} 'ZZtop@host' >/dev/null 2>&1 || \
	fatal "ezmlm-sub: failed to find address in ${DIR}/allow"
  run ezmlm-list "$DIR" allow | ${GREP} 'ZZtop@host' >/dev/null 2>&1 || \
	fatal "ezmlm-sub: failed to find address in ${DIR} allow"

# list subscribers
  run ezmlm-list "$DIR" | ${GREP} "xyZZy" >/dev/null 2>&1 || \
	fatal "ezmlm-list: failed to list subscribers"

# remove subscriber
  file_run ezmlm-unsub "$DIR" "xYzZy@hOst" || \
	fatal "ezmlm-unsub: failed to remove subscriber"

# see that it was removed
  run ezmlm-list "$DIR" | ${GREP} "xyZZy" >/dev/null 2>&1 && \
	fatal "ezmlm-unsub: failed to remove address"

  SENDER="zztop@HOst"

# check for address in allow
  file_run ezmlm-issubn "$DIR" "${DIR}/allow" || \
	fatal "ezmlm-sub/issubn: failed to add/look in 2nd db (absolute)"
  file_run ezmlm-issubn "$DIR" . allow || \
	fatal "ezmlm-sub/issubn: failed to add/look in 2nd db (relative)"

# remove (multiple) (non)existing addresses from allow
  file_run ezmlm-unsub "${DIR}/allow" "xYzZy@hOst" "zZToP@HOSt" || \
	fatal "ezmlm-unsub: failed to remove subscriber"

# verify removal
  file_run ezmlm-issubn "$DIR" . allow && \
	fatal "ezmlm-unsub/issubn: failed to remove address"

# clean up
  LOCAL=''

  ${ECHO} "OK"
