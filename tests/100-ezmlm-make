# $Id$

##############
# ezmlm-make #
##############

if [ "$SECT" = "1" ]; then

  prompt "ezmlm-make (1/2):     "

# edit non-existant list
  ${EZBIN}/ezmlm-make -e -C${EZBIN}/ezmlmrc "$DIR" "${DOT}" \
	"$LOC" "$HOST" > /dev/null 2>&1 && \
	fatal "ezmlm-make failed reject edit of non-existing list:"

# make simple test list
  ${EZBIN}/ezmlm-make -C${EZBIN}/ezmlmrc "$DIR" "${DOT}" \
	"$LOC" "$HOST" || \
	fatal "ezmlm-make failed to create test list"

# remake simple test list which should fail
  ${EZBIN}/ezmlm-make -C${EZBIN}/ezmlmrc "$DIR" "${DOT}" \
	"$LOC" "$HOST" >/dev/null 2>&1 && \
	fatal "failed to reject creation of existing list"

# edit the list (add digest)
  ${EZBIN}/ezmlm-make -+d -C${EZBIN}/ezmlmrc "$DIR" || \
	fatal "ezmlm-make failed to edit test list"

# edit the list (add digest)
  ${MV} "${DIR}/config" "${DIR}/config~"
  ${EZBIN}/ezmlm-make -ed -C${EZBIN}/ezmlmrc "$DIR" "$DOT" "$LOC" "$HOST" \
	>/dev/null 2>&1 || \
	{ ${ECHO} "failed without DIR/config: 0.313 bug, fixed in 0.314."
	  prompt "ezmlm-make ......     "
	  BUG="${BUG} config"
	}
  ${MV} "${DIR}/config~" "${DIR}/config"

  ${GREP} "ezmlm-weed" "${DIR}/bouncer" >/dev/null 2>&1 || \
	fatal "no ezmlm-weed in bouncer"
  ${GREP} "ezmlm-return" "${DIR}/bouncer" >/dev/null 2>&1 || \
	{ ${ECHO} "no ezmlm-return in bouncer: 0.32 bug, fixed in 0.321."
	  prompt "ezmlm-make ......     "
	  BUG="${BUG} return"
	}
# digest/bouncer only for >=0.32
  if [  "$EZVER" != '31' ]; then
    if [ ! -f "${DIR}/digest/bouncer" ]; then
	fatal "failed to create digest/bouncer";
    fi
    ${GREP} "ezmlm-weed" "${DIR}/digest/bouncer" >/dev/null 2>&1 || \
	fatal "no ezmlm-weed in bouncer"
    ${GREP} "ezmlm-return" "${DIR}/digest/bouncer" >/dev/null 2>&1 || \
	{ ${ECHO} "no ezmlm-return in digest/bouncer: 0.32 bug, OK in 0.321."
	  prompt "ezmlm-make ......     "
	  BUG="${BUG} return"
	}
  fi
  ${ECHO} "OK"

# Add sql files for sql testing
RDBMS='STD'
prompt "Using RDBMS support:  "
if [ $USESQL ]; then
  ${EZBIN}/ezmlm-make -+6 "$SQLHOST::$SQLUSER:$PW:$DB:$TABLE" \
	-C${EZBIN}/ezmlmrc "$DIR"|| \
	fatal "ezmlm-make failed to add SQL config info"

  ${STRINGS} ${EZBIN}/ezmlm-sub | ${GREP} -i 'MySQL' >/dev/null 2>&1 && \
	RDBMS='MySQL'
  ${STRINGS} ${EZBIN}/ezmlm-sub | ${GREP} -i 'libpq.' >/dev/null 2>&1 && \
	RDBMS='PostgreSQL'
  if [ "$RDBMS" = 'STD' ]; then
	${ECHO} "No recognized support. If none, will default to std dbs."
  else
	${ECHO} "$RDBMS. Hope empty tables exist."
  fi

else
	${ECHO} "No."
fi

###############################################################
# set up subscriber/moderator/sender/digest recipient account #
###############################################################
  ${MKDIR} "$SINKDIR" "$SINKDIR/new" "$SINKDIR/cur" "$SINKDIR/tmp" || \
	fatal "mkdir for sinkdir failed"
  ${MKDIR} "$MODDIR" "$MODDIR/new" "$MODDIR/cur" "$MODDIR/tmp" || \
	fatal "mkdir for moddir failed"
  ${MKDIR} "$MANDIR" "$MANDIR/new" "$MANDIR/cur" "$MANDIR/tmp" || \
	fatal "mkdir for mandir failed"
  ${MKDIR} "$DIGDIR" "$DIGDIR/new" "$DIGDIR/cur" "$DIGDIR/tmp" || \
	fatal "mkdir for digdir failed"

####################################
# correct bouncer for our binaries #
####################################
# NOTE: This is duplicated (and should be) after next ezmlm-make block.
  ${ECHO} "|/${EZBIN}/ezmlm-weed" > "${DIR}/bouncer"
  ${ECHO} "|/${EZBIN}/ezmlm-weed" > "${DIR}/digest/bouncer"
  if [ "$EZVER" = "31" ]; then	# autodetecting bouncer for 0.31x
    ${ECHO} "|/${EZBIN}/ezmlm-return '${DIR}'" >> "${DIR}/bouncer"
    ${ECHO} "|/${EZBIN}/ezmlm-return '${DIR}'" >> "${DIR}/digest/bouncer"
  else				# split bouncer with args for later versions
	# edited for ezmlm-new
    ${ECHO} "|/${EZBIN}/ezmlm-return '${DIR}'" >> "${DIR}/bouncer"
    ${ECHO} "|/${EZBIN}/ezmlm-return '${DIR}'" >> "${DIR}/digest/bouncer"
  fi

  # remove inlocal/inhost - shouldn't be used
  ${RM} -f "${DIR}/inlocal" "${DIR}/inhost" > /dev/null || \
    fatal "failed to remove inlocal/inhost for testlist"

###########################
# set up bouncing account #
###########################
  ${ECHO} "|${GREP} 'MAILER-DAEMON' >/dev/null && exit 99" > "$DOT-$BOUNCE"
  ${ECHO} "|exit 100" > "$DOT-$BOUNCE"

  (
    ${ECHO} "#!/bin/sh"
    ${ECHO} "${CAT} >'${QQMSG}'"
    ${ECHO} "${CAT} <&1 >'${QQENV}'"
    ${ECHO} "${SED} -e '/^$/,\$d' <'${QQMSG}' >'${QQHDR}'"
    ${ECHO} "${SED} -e '1,/^$/d' <'${QQMSG}' >'${QQBODY}'"
    ${ECHO} "cp '${QQMSG}' '${QQMSG}'.\$\$"
    ${ECHO} "exit 0"
  ) > "$QQTEST"
  ${CHMOD} 755 "$QQTEST"

fi
