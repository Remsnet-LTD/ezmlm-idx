# $Id$

################
# ezmlm-manage #
################

if [ "$SECT" -le "2" ]; then

prompt "ezmlm-manage (2/4):   "

# check digest-subscribe and list-unsubscribe replies
SUB1=`${GREP} -l 'sub1' $MANDIR/new/*` || \
	fatal "failed getting digest-subscribe confirm request"

SUB2=`${GREP} -l 'sub2' $MANDIR/new/*` || \
	fatal "failed getting -unsubscribe confirm request"

# Check -get.1 reply
MANGET1=`${GREP} -l 'manget1' $MANDIR/new/*` || \
	fatal "failed getting -get.1 reply"

${GREP} 'msg1' "$MANGET1" >/dev/null || \
	fatal "get.1 failed to return archived message"

# Add moderator
${EZBIN}/ezmlm-sub "${DIR}/mod" "${MOD}@$HOST"

LOCAL=`${GREP} "Reply-To:" "$SUB1" | cut -d' ' -f2 | cut -d'@' -f1` || \
	fatal "failed to find confirm address in -subscribe reply"
export LOCAL
DEFAULT=`${ECHO} "$LOCAL" | cut -c"$LOCLEN"-`; export DEFAULT
${ECHO} "X-num: sub3" > "${TMP}"
${ECHO} "From: Mr. $EZTEST confirms <$SENDER>" >> "${TMP}"
${ECHO} >> "${TMP}"
${EZBIN}/ezmlm-manage ${SW_FROM} "${DIR}" < "${TMP}" \
		>"${ERR}" 2>&1 || \
	fatal "failed to send user conf for sub1"

LOCAL=`${GREP} "Reply-To:" "$SUB2" | cut -d' ' -f2 | cut -d'@' -f1` || \
	fatal "failed to find confirm address in -unsubscribe reply"
export LOCAL
DEFAULT=`${ECHO} "$LOCAL" | cut -c"$LOCLEN"-`; export DEFAULT
${ECHO} "X-num: sub4" > "${TMP}"
${EZBIN}/ezmlm-manage "${DIR}" < "${TMP}" >/dev/null 2>&1 || \
	fatal "failed to send conf for sub2"

# now test remote admin functions
# add a few addresses to allow
${EZBIN}/ezmlm-sub "${DIR}/${ALLOW}" "aaa@bbb" "ccc@ddd" "eee@fff"

# test -edit
${ECHO} "#TEST_TEXT#" > "${DIR}/text/test"
LOCAL="$LOC-edit.test-$MAN=$HOST"; export LOCAL
DEFAULT="edit.test-$MAN=$HOST"; export DEFAULT
${ECHO} "X-num: edit1" > "${TMP}"
${EZBIN}/ezmlm-manage -e "${DIR}" < "${TMP}" >/dev/null 2>&1 && \
	fatal "failed to reject edit request from non-mod"
LOCAL="$LOC-edit.test-$MOD=$HOST"; export LOCAL
DEFAULT="edit.test-$MOD=$HOST"; export DEFAULT
${ECHO} "X-num: edit2" > "${TMP}"
${EZBIN}/ezmlm-manage "${DIR}" < "${TMP}" >"${ERR}" 2>&1 && \
	fatal "-E failed for edit2"
${ECHO} "X-num: edit3" > "${TMP}"
${EZBIN}/ezmlm-manage -e "${DIR}" < "${TMP}" >"${ERR}" 2>&1 || \
	fatal "-e failed for remote admin for edit3"

# test list/log
LOCAL="$LOC-allow-list-$MAN=$HOST"; export LOCAL
DEFAULT="allow-list-$MAN=$HOST"; export DEFAULT
${ECHO} "X-num: list1" > "${TMP}"
${EZBIN}/ezmlm-manage -l "${DIR}" < "${TMP}" >/dev/null 2>&1 && \
	fatal "failed to reject list request from non-mod"

LOCAL="$LOC-allow-log-$MAN=$HOST"; export LOCAL
DEFAULT="allow-log-$MAN=$HOST"; export DEFAULT
${ECHO} "X-num: log1" > "${TMP}"
${EZBIN}/ezmlm-manage -l "${DIR}" < "${TMP}" >/dev/null 2>&1 && \
	fatal "failed to reject log request from non-mod"

LOCAL="$LOC-allow-list-$MOD=$HOST"; export LOCAL
DEFAULT="allow-list-$MOD=$HOST"; export DEFAULT
${ECHO} "X-num: list2" > "${TMP}"
${EZBIN}/ezmlm-manage "${DIR}" < "${TMP}" >/dev/null 2>&1 && \
	fatal "-L failed to reject list request"

${ECHO} "X-num: list3" > "${TMP}"
${EZBIN}/ezmlm-manage -l "${DIR}" < "${TMP}" >"${ERR}" 2>&1 || \
	fatal "-l failed for remote admin for list3"

LOCAL="$LOC-allow-log-$MOD=$HOST"; export LOCAL
DEFAULT="allow-log-$MOD=$HOST"; export DEFAULT
${ECHO} "X-num: log2" > "${TMP}"
${EZBIN}/ezmlm-manage "${DIR}" < "${TMP}" >"${ERR}" 2>&1 && \
	fatal "-L failed to reject log request"

${ECHO} "X-num: log3" > "${TMP}"
${EZBIN}/ezmlm-manage -l "${DIR}" < "${TMP}" >"${ERR}" 2>&1 || \
	fatal "-l failed for remote admin for log3"


${ECHO} "OK"

fi
